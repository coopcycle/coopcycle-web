{% extends "admin.html.twig" %}
{% set user = incident.getCreatedBy() %}
{% set customerUserInfo = incident.getCustomerUserInfo() %}

{% block breadcrumb %}
<li>
  <a href="{{ path('admin_incidents') }}">{% trans %}adminDashboard.shops.title{% endtrans %}</a>
</li>
<li>
  Incident #{{incident.id}}
</li>
{% endblock %}

{% block content %}
<div class="incident-header">
<div class="container">
<div class="row">

  <div class="btn-group col-md-1 priority-group" align="center">
    <button type="button" class="thumbnail priority p{{ incident.getPriority() }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <div>P{{ incident.getPriority() }} <span class="caret"></span></div>
    </button>
    <ul class="dropdown-menu">
      <li><a href="#">Priority 1 (high)</a></li>
      <li><a href="#">Priority 2 (medium)</a></li>
      <li><a href="#">Priority 3 (low)</a></li>
  </ul>
  </div>

  <div class="col-md-9">
    <span class="text-muted">{{ incident.getCreatedAt() | date }}</span>
    <h1>{{ incident.title }}</h1>
    <a href="#">Add tags</a>
  </div>

  <div class="col-md-2 text-right">
    <p>
    <div class="btn-group">
      <button type="button" class="btn btn-danger dropdown-toggle"
      data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        {{incident.getStatus()}} <span class="caret"></span>
      </button>
      <ul class="dropdown-menu">
        <li><a href="#">Open the issue</a></li>
        <li><a href="#">Close the issue</a></li>
        <li><a href="#">Resolve the issue</a></li>
        <li role="separator" class="divider"></li>
        <li><a href="#">Reopen the issue</a></li>
      </ul>
    </div>
    </p>
    {% if user is not null %}
      <p>Created by: <i class="fa fa-user" aria-hidden="true"></i> {{ incident.getCreatedBy().username }}</p>
    {% endif %}

  </div>

</div>
</div>
</div>

<div class="container incident-body">
<div class="col-md-9">
<div class="row">
<p style="font-weight: bold" >Description</p>
<p>{{ incident.description }}</p>
</div>
<hr>
<div class="row">
<p>Attachments <span class="caret"></span></p>
{% for image in incident.getImages() %}
  <a class="thumbnail" style="width: 128px; height: 128px">
    <img src="{{ coopcycle_asset(image, 'file', 'incident_image_thumbnail') }}" />
  </a>
{% endfor %}
</div>
<hr>
{% for event in incident.getEvents() %}
{% set username = event.getCreatedBy().getUsername() %}
<div class="media">
  <div class="media-left media-top">
    <a href="#">
      <img class="media-object" src="{{ path('user_avatar', { username: username }) }}" alt="{{username}}">
    </a>
  </div>
  <div class="media-body">
<div class="panel panel-default">
  <div class="panel-heading">
    <span class="font-weight-bold">{{ username }}<span> <span class="text-muted font-weight-light">{{ event.getCreatedAt()|time_diff }}</span>
  </div>
  <div class="panel-body">
    {{ event.getMessage() }}
  </div>
</div>
  </div>
</div>
{% endfor %}
</div>

<div class="col-md-3">
  <h4>Customer details</h4>
  {% if customerUserInfo is not null %}
  <p><i class="fa fa-user" aria-hidden="true"></i> {{customerUserInfo.getUsername()}}</p>
  <p><i class="fa fa-phone" aria-hidden="true"></i> {{customerUserInfo.getTelephone()}}</p>
  <p><i class="fa fa-envelope" aria-hidden="true"></i> {{customerUserInfo.getEmail()}}</p>
  {% endif %}

  <h4>Tasks concerning this incident</h4>
  <ul class="task-list">
  {% for task in incident.getTasks() %}
    <li>
      <span>task #{{ task.getId() }}</span>
      {% if task.getDelivery() is not null %}
        <span>(delivery <a href="{{ path('admin_delivery', { id: task.getDelivery().getId() }) }}">#{{ task.getDelivery().getId() }})</a></span>
      {% endif %}
    </li>
    <ul>
    {% for event in task.getEvents() %}
      {% include "components/incident/timeline_task_item.html.twig" with {task: task} %}
    {% endfor %}
    </ul>
  {% endfor %}
  </ul>
  <h4>Actions</h4>
  <button type="button" class="btn btn-block btn-sm btn-success">Reschedule incidented task</button>
  <button type="button" class="btn btn-block btn-sm btn-warning">Cancel incidented task</button>
  <button type="button" class="btn btn-block btn-sm btn-danger">Cancel all tasks</button>
</div>
</div>


{% endblock %}

{% block styles %}
  {{ encore_entry_link_tags('incident-form') }}
{% endblock %}

{% block scripts %}
  {{ encore_entry_script_tags('incident-form') }}
{% endblock %}
